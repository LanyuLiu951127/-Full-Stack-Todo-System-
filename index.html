<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ˆæ¥­ä»»å‹™ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-slate-100 dark:bg-gray-900 min-h-screen flex items-center justify-center p-4 font-sans transition-colors duration-200">

    <button onclick="toggleDarkMode()" class="fixed top-4 right-4 p-3 rounded-full bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition z-50 text-xl">
        <span class="dark:hidden">ğŸŒ™</span>
        <span class="hidden dark:inline">â˜€ï¸</span>
    </button>

    <div id="authBox" class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm transition-colors duration-200">
        <h2 id="authTitle" class="text-2xl font-bold mb-6 text-center text-indigo-600 dark:text-indigo-400">ä»»å‹™ç³»çµ±ç™»å…¥</h2>
        <input type="text" id="user" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" class="w-full mb-3 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        <input type="password" id="pass" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full mb-6 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        
        <!-- è¨»å†Šæ™‚é¡¯ç¤ºçš„å®‰å…¨å•é¡Œæ¬„ä½ -->
        <div id="registerFields" class="hidden mb-4 space-y-3">
            <select id="regQuestion" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="ä½ çš„ç¬¬ä¸€éš»å¯µç‰©åå­—ï¼Ÿ">ä½ çš„ç¬¬ä¸€éš»å¯µç‰©åå­—ï¼Ÿ</option>
                <option value="ä½ åœ‹å°å°±è®€å“ªæ‰€å­¸æ ¡ï¼Ÿ">ä½ åœ‹å°å°±è®€å“ªæ‰€å­¸æ ¡ï¼Ÿ</option>
                <option value="ä½ æ¯è¦ªçš„å¨˜å®¶å§“æ°ï¼Ÿ">ä½ æ¯è¦ªçš„å¨˜å®¶å§“æ°ï¼Ÿ</option>
            </select>
            <input type="text" id="regAnswer" placeholder="è«‹è¼¸å…¥å®‰å…¨å•é¡Œç­”æ¡ˆ" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        </div>

        <button id="authSubmit" onclick="auth('login')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition mb-2">ç™»å…¥</button>
        <button id="authToggle" onclick="toggleAuthMode()" class="w-full text-indigo-600 py-2 font-medium hover:underline">æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š</button>
        <button id="forgotLink" onclick="toggleResetMode(true)" class="w-full text-gray-500 text-sm mt-2 hover:underline dark:text-gray-400">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
    </div>

    <!-- å¿˜è¨˜å¯†ç¢¼å€å¡Š -->
    <div id="resetBox" class="hidden bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm transition-colors duration-200">
        <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600 dark:text-indigo-400">é‡è¨­å¯†ç¢¼</h2>
        <input type="text" id="resetUser" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" class="w-full mb-3 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        <div id="resetStep2" class="hidden space-y-3">
            <p id="resetQuestionDisplay" class="text-sm font-bold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">å•é¡Œï¼š...</p>
            <input type="text" id="resetAnswer" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <input type="password" id="newPass" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        </div>
        <button id="resetBtn" onclick="handleResetStep1()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition mt-4 mb-2">æŸ¥è©¢å•é¡Œ</button>
        <button onclick="toggleResetMode(false)" class="w-full text-gray-500 py-2 font-medium hover:underline">è¿”å›ç™»å…¥</button>
    </div>

    <div id="mainApp" class="hidden w-full max-w-3xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden self-start mt-10 transition-colors duration-200">
        <div class="p-6 bg-indigo-600 text-white flex justify-between items-center">
            <h1 id="pageTitle" class="text-xl font-bold">æˆ‘çš„ä»»å‹™æ¸…å–®</h1>
            <div class="flex gap-2">
                <button onclick="showProfile()" class="bg-indigo-500 hover:bg-indigo-400 px-4 py-1 rounded-lg text-sm transition">å€‹äººè³‡æ–™</button>
                <button onclick="logout()" class="bg-indigo-500 hover:bg-indigo-400 px-4 py-1 rounded-lg text-sm transition">ç™»å‡º</button>
            </div>
        </div>

        <div id="todoView">
        <div class="p-6 bg-indigo-50 dark:bg-gray-700 space-y-4 transition-colors duration-200">
            <div class="flex gap-2">
                <select id="searchPriority" onchange="fetchTodos()" class="p-3 rounded-lg border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none bg-white dark:bg-gray-600 dark:text-white min-w-[120px]">
                    <option value="all">å…¨éƒ¨ç­‰ç´š</option>
                    <option value="é«˜">ğŸ”´ é«˜</option>
                    <option value="ä¸­">ğŸŸ¡ ä¸­</option>
                    <option value="ä½">ğŸŸ¢ ä½</option>
                </select>
                <select id="searchCategory" onchange="fetchTodos()" class="p-3 rounded-lg border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none bg-white dark:bg-gray-600 dark:text-white min-w-[120px]">
                    <option value="all">å…¨éƒ¨åˆ†é¡</option>
                    <option value="å·¥ä½œ">ğŸ’¼ å·¥ä½œ</option>
                    <option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option>
                    <option value="å­¸ç¿’">ğŸ“š å­¸ç¿’</option>
                    <option value="å…¶ä»–">ğŸ“‚ å…¶ä»–</option>
                </select>
                <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹ä»»å‹™å…§å®¹..." class="flex-1 p-3 rounded-lg border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none dark:bg-gray-600 dark:text-white dark:placeholder-gray-400">
                <button onclick="fetchTodos()" class="bg-indigo-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-600 shadow-md transition">æœå°‹</button>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <input type="text" id="todoInput" placeholder="ä»»å‹™åç¨±..." class="flex-1 min-w-[200px] p-3 rounded-lg border shadow-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:placeholder-gray-400">
                <input type="date" id="dateInput" class="p-3 rounded-lg border shadow-sm dark:bg-gray-600 dark:text-white dark:border-gray-500">
                <select id="priorityInput" class="p-3 rounded-lg border shadow-sm dark:bg-gray-600 dark:text-white dark:border-gray-500">
                    <option value="é«˜">ğŸ”´ é«˜å„ªå…ˆç´š</option>
                    <option value="ä¸­" selected>ğŸŸ¡ ä¸­å„ªå…ˆç´š</option>
                    <option value="ä½">ğŸŸ¢ ä½å„ªå…ˆç´š</option>
                </select>
                <select id="categoryInput" class="p-3 rounded-lg border shadow-sm dark:bg-gray-600 dark:text-white dark:border-gray-500">
                    <option value="å·¥ä½œ">ğŸ’¼ å·¥ä½œ</option>
                    <option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option>
                    <option value="å­¸ç¿’">ğŸ“š å­¸ç¿’</option>
                    <option value="å…¶ä»–" selected>ğŸ“‚ å…¶ä»–</option>
                </select>
            </div>
            <div class="flex gap-3">
                <textarea id="memoInput" maxlength="250" placeholder="å‚™è¨» (é¸å¡«, é™250å­—)..." class="flex-1 p-3 rounded-lg border shadow-sm resize-none overflow-y-auto h-12 dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:placeholder-gray-400"></textarea>
                <button id="submitBtn" onclick="handleSubmit()" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-md transition">æ–°å¢</button>
                <button id="cancelBtn" onclick="resetForm()" class="hidden bg-gray-400 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500 shadow-md transition">å–æ¶ˆ</button>
            </div>
        </div>

        <ul id="todoList" class="divide-y divide-gray-100 dark:divide-gray-700 overflow-y-auto max-h-[500px]">
            </ul>
        </div>

        <!-- å€‹äººè³‡æ–™é é¢ -->
        <div id="profileView" class="hidden p-8 space-y-6 dark:text-white">
            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                <p class="text-gray-500 dark:text-gray-300 text-sm mb-1">ç›®å‰ç™»å…¥å¸³è™Ÿ</p>
                <p id="profileUsername" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"></p>
            </div>
            
            <div class="space-y-4">
                <h3 class="text-lg font-bold border-b pb-2 dark:border-gray-600">ä¿®æ”¹å¯†ç¢¼</h3>
                <input type="password" id="oldPass" placeholder="è«‹è¼¸å…¥èˆŠå¯†ç¢¼" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                <input type="password" id="newPassChange" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                <button onclick="changePassword()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">ç¢ºèªä¿®æ”¹</button>
            </div>

            <div class="space-y-4 pt-4 border-t dark:border-gray-600">
                <h3 class="text-lg font-bold border-b pb-2 dark:border-gray-600">ä¿®æ”¹å®‰å…¨å•é¡Œ</h3>
                <input type="password" id="secPass" placeholder="è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼ä»¥é©—è­‰èº«åˆ†" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                <select id="newQuestion" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    <option value="ä½ çš„ç¬¬ä¸€éš»å¯µç‰©åå­—ï¼Ÿ">ä½ çš„ç¬¬ä¸€éš»å¯µç‰©åå­—ï¼Ÿ</option>
                    <option value="ä½ åœ‹å°å°±è®€å“ªæ‰€å­¸æ ¡ï¼Ÿ">ä½ åœ‹å°å°±è®€å“ªæ‰€å­¸æ ¡ï¼Ÿ</option>
                    <option value="ä½ æ¯è¦ªçš„å¨˜å®¶å§“æ°ï¼Ÿ">ä½ æ¯è¦ªçš„å¨˜å®¶å§“æ°ï¼Ÿ</option>
                </select>
                <input type="text" id="newAnswer" placeholder="è«‹è¼¸å…¥æ–°çš„ç­”æ¡ˆ" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                <button onclick="changeSecurityQuestion()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">æ›´æ–°å®‰å…¨å•é¡Œ</button>
                <button onclick="showTodos()" class="w-full text-gray-500 py-2 font-medium hover:underline dark:text-gray-400">è¿”å›ä»»å‹™åˆ—è¡¨</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let currentUser = JSON.parse(localStorage.getItem('user'));
        let isLoginMode = true;
        let editingId = null; // è¿½è¹¤æ­£åœ¨ç·¨è¼¯çš„ä»»å‹™ ID
        let allTodos = []; // å„²å­˜ç›®å‰åˆ—è¡¨è³‡æ–™ä¾›ç·¨è¼¯ä½¿ç”¨

        // åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('authTitle');
            const submitBtn = document.getElementById('authSubmit');
            const toggleBtn = document.getElementById('authToggle');
            const regFields = document.getElementById('registerFields');
            const forgotLink = document.getElementById('forgotLink');

            if (isLoginMode) {
                title.innerText = 'ä»»å‹™ç³»çµ±ç™»å…¥';
                submitBtn.innerText = 'ç™»å…¥';
                submitBtn.onclick = () => auth('login');
                toggleBtn.innerText = 'æ²’æœ‰å¸³è™Ÿï¼Ÿé»æ­¤è¨»å†Š';
                regFields.classList.add('hidden');
                forgotLink.classList.remove('hidden');
            } else {
                title.innerText = 'è¨»å†Šæ–°å¸³è™Ÿ';
                submitBtn.innerText = 'è¨»å†Š';
                submitBtn.onclick = () => auth('register');
                toggleBtn.innerText = 'å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥';
                regFields.classList.remove('hidden');
                forgotLink.classList.add('hidden');
            }
        }

        function toggleResetMode(show) {
            document.getElementById('authBox').classList.toggle('hidden', show);
            document.getElementById('resetBox').classList.toggle('hidden', !show);
            // é‡ç½®é‡è¨­è¡¨å–®ç‹€æ…‹
            if(show) {
                document.getElementById('resetStep2').classList.add('hidden');
                document.getElementById('resetBtn').innerText = 'æŸ¥è©¢å•é¡Œ';
                document.getElementById('resetBtn').onclick = handleResetStep1;
                document.getElementById('resetUser').value = '';
                document.getElementById('resetUser').disabled = false;
            }
        }

        async function handleResetStep1() {
            const username = document.getElementById('resetUser').value;
            if(!username) return alert("è«‹è¼¸å…¥å¸³è™Ÿ");

            const res = await fetch(`${API}/get-question`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            const data = await res.json();
            
            if(data.success) {
                document.getElementById('resetQuestionDisplay').innerText = `ğŸ”’ å®‰å…¨å•é¡Œï¼š${data.question}`;
                document.getElementById('resetStep2').classList.remove('hidden');
                document.getElementById('resetUser').disabled = true; // é–å®šå¸³è™Ÿæ¬„ä½
                
                const btn = document.getElementById('resetBtn');
                btn.innerText = 'é‡è¨­å¯†ç¢¼';
                btn.onclick = handleResetStep2;
            } else {
                alert(data.message);
            }
        }

        async function handleResetStep2() {
            const username = document.getElementById('resetUser').value;
            const answer = document.getElementById('resetAnswer').value;
            const newPassword = document.getElementById('newPass').value;

            if(!answer || !newPassword) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            const res = await fetch(`${API}/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, answer, newPassword })
            });
            const data = await res.json();

            if(data.success) {
                alert("å¯†ç¢¼é‡è¨­æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚");
                toggleResetMode(false);
            } else {
                alert(data.message);
            }
        }

        async function auth(type) {
            const username = document.getElementById('user').value;
            const password = document.getElementById('pass').value;
            const question = document.getElementById('regQuestion').value;
            const answer = document.getElementById('regAnswer').value;

            if(!username || !password) return alert("è«‹å¡«å¯«å¸³è™Ÿå¯†ç¢¼");
            if(type === 'register' && (!question || !answer)) return alert("è«‹è¨­å®šå®‰å…¨å•é¡Œèˆ‡ç­”æ¡ˆ");
            
            try {
                const res = await fetch(`${API}/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, question, answer })
                });
                const data = await res.json();
                if (data.success) {
                    if (type === 'login') {
                        currentUser = data.user;
                        localStorage.setItem('token', data.token); // å„²å­˜ Token
                        localStorage.setItem('user', JSON.stringify(data.user));
                        checkAuth();
                    } else {
                        alert('è¨»å†ŠæˆåŠŸï¼ç¾åœ¨è«‹è¼¸å…¥å¸³å¯†é€²è¡Œç™»å…¥');
                        toggleAuthMode(); // è‡ªå‹•åˆ‡æ›å›ç™»å…¥æ¨¡å¼
                    }
                } else alert(data.message);
            } catch(e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦å•Ÿå‹•"); }
        }

        function checkAuth() {
            if (currentUser) {
                document.getElementById('authBox').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                fetchTodos();
            }
        }

        function logout() { localStorage.removeItem('user'); localStorage.removeItem('token'); location.reload(); }

        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        async function fetchTodos() {
            if(!currentUser) return;
            const q = document.getElementById('searchInput').value;
            const priority = document.getElementById('searchPriority').value;
            const category = document.getElementById('searchCategory').value;
            const token = localStorage.getItem('token');
            
            const list = document.getElementById('todoList');
            list.innerHTML = '<p class="text-center text-gray-500 p-5">â³ è¼‰å…¥ä»»å‹™ä¸­...</p>';

            try {
                const res = await fetch(`${API}/todos?q=${q}&priority=${priority}&category=${category}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401 || res.status === 403) return logout(); // Token å¤±æ•ˆå‰‡ç™»å‡º

                const todos = await res.json();
                allTodos = todos; // æ›´æ–°å…¨åŸŸè³‡æ–™
                
                if (!Array.isArray(todos)) return; // ç¢ºä¿è³‡æ–™æ ¼å¼æ­£ç¢º

                const priorityColors = {
                    'é«˜': 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800',
                    'ä¸­': 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800',
                    'ä½': 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800'
                };

                const categoryColors = {
                    'å·¥ä½œ': 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800',
                    'ç”Ÿæ´»': 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800',
                    'å­¸ç¿’': 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800',
                    'å…¶ä»–': 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600'
                };

                list.innerHTML = todos.map(t => {
                    const pBadge = priorityColors[t.priority] || 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300';
                    const cBadge = categoryColors[t.category] || categoryColors['å…¶ä»–'];
                    return `
                <li class="flex items-center justify-between p-5 hover:bg-gray-50 dark:hover:bg-gray-700 transition ${t.done ? 'bg-gray-50 dark:bg-gray-700' : ''}">
                    <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="toggleTodo(${t.id})">
                        <div class="w-6 h-6 shrink-0 border-2 rounded-full flex items-center justify-center transition ${t.done ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 dark:border-gray-500'}">
                            ${t.done ? 'âœ“' : ''}
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded text-xs font-bold border ${cBadge}">${escapeHtml(t.category || 'å…¶ä»–')}</span>
                                <span class="px-2 py-0.5 rounded text-xs font-bold border ${pBadge}">${escapeHtml(t.priority)}</span>
                                <p class="font-semibold ${t.done ? 'line-through text-gray-400' : 'text-gray-800 dark:text-gray-100'}">${escapeHtml(t.text)}</p>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 ml-1 mb-1">ğŸ“… ${t.due_date || 'ç„¡æœŸé™'} ${t.memo ? `| ğŸ“ ${escapeHtml(t.memo)}` : ''}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startEdit(${t.id})" class="text-gray-400 dark:text-gray-500 hover:text-indigo-600 transition px-1">âœï¸</button>
                        <button onclick="deleteTodo(${t.id})" class="text-gray-400 dark:text-gray-500 hover:text-red-500 transition px-1">ğŸ—‘ï¸</button>
                    </div>
                </li>
            `}).join('');
            } catch (e) {
                console.error("è®€å–ä»»å‹™å¤±æ•—:", e);
            }
        }

        async function handleSubmit() {
            const text = document.getElementById('todoInput');
            const date = document.getElementById('dateInput');
            const priority = document.getElementById('priorityInput');
            const category = document.getElementById('categoryInput');
            const memo = document.getElementById('memoInput');
            const token = localStorage.getItem('token');
            if (!text.value.trim()) return;

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'è™•ç†ä¸­...';

            const url = editingId ? `${API}/todos/${editingId}` : `${API}/todos`;
            const method = editingId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        text: text.value, 
                        due_date: date.value, 
                        priority: priority.value,
                        memo: memo.value,
                        category: category.value
                    })
                });
                const data = await res.json();
                
                if (!data.success) {
                    alert(data.message);
                } else {
                    resetForm();
                    fetchTodos();
                }
            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function startEdit(id) {
            const todo = allTodos.find(t => t.id === id);
            if (!todo) return;

            editingId = id;
            document.getElementById('todoInput').value = todo.text;
            document.getElementById('dateInput').value = todo.due_date;
            document.getElementById('priorityInput').value = todo.priority;
            document.getElementById('categoryInput').value = todo.category || 'å…¶ä»–';
            document.getElementById('memoInput').value = todo.memo || '';
            
            document.getElementById('submitBtn').innerText = 'æ›´æ–°';
            document.getElementById('submitBtn').classList.replace('bg-indigo-600', 'bg-green-600');
            document.getElementById('submitBtn').classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('todoInput').focus();
        }

        function resetForm() {
            editingId = null;
            document.getElementById('todoInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('priorityInput').value = 'ä¸­';
            document.getElementById('categoryInput').value = 'å…¶ä»–';
            document.getElementById('memoInput').value = '';
            document.getElementById('searchInput').value = ''; 
            document.getElementById('searchPriority').value = 'all';
            document.getElementById('searchCategory').value = 'all';

            document.getElementById('submitBtn').innerText = 'æ–°å¢';
            document.getElementById('submitBtn').classList.replace('bg-green-600', 'bg-indigo-600');
            document.getElementById('submitBtn').classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        async function toggleTodo(id) { 
            const token = localStorage.getItem('token');
            await fetch(`${API}/todos/${id}/toggle`, { 
                method: 'PUT', 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                } 
            }); 
            fetchTodos(); 
        }
        async function deleteTodo(id) { 
            const token = localStorage.getItem('token');
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { 
                await fetch(`${API}/todos/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); 
                fetchTodos(); 
            } 
        }

        function showProfile() {
            document.getElementById('todoView').classList.add('hidden');
            document.getElementById('profileView').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = 'å€‹äººè³‡æ–™è¨­å®š';
            document.getElementById('profileUsername').innerText = currentUser.username;
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('oldPass').value = '';
            document.getElementById('newPassChange').value = '';
            document.getElementById('secPass').value = '';
            document.getElementById('newAnswer').value = '';
        }

        function showTodos() {
            document.getElementById('profileView').classList.add('hidden');
            document.getElementById('todoView').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = 'æˆ‘çš„ä»»å‹™æ¸…å–®';
        }

        async function changePassword() {
            const oldPassword = document.getElementById('oldPass').value;
            const newPassword = document.getElementById('newPassChange').value;
            const token = localStorage.getItem('token');
            if(!oldPassword || !newPassword) return alert("è«‹è¼¸å…¥èˆŠå¯†ç¢¼èˆ‡æ–°å¯†ç¢¼");

            const res = await fetch(`${API}/change-password`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ oldPassword, newPassword })
            });
            const data = await res.json();
            if(data.success) {
                alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼");
                showTodos(); // ä¿®æ”¹æˆåŠŸå¾Œè¿”å›åˆ—è¡¨
            } else {
                alert(data.message);
            }
        }

        async function changeSecurityQuestion() {
            const password = document.getElementById('secPass').value;
            const newQuestion = document.getElementById('newQuestion').value;
            const newAnswer = document.getElementById('newAnswer').value;
            const token = localStorage.getItem('token');

            if(!password || !newQuestion || !newAnswer) return alert("è«‹å¡«å¯«å¯†ç¢¼èˆ‡æ–°çš„å•é¡Œç­”æ¡ˆ");

            const res = await fetch(`${API}/change-security-question`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ password, newQuestion, newAnswer })
            });
            const data = await res.json();
            if(data.success) {
                alert("å®‰å…¨å•é¡Œä¿®æ”¹æˆåŠŸï¼");
                document.getElementById('secPass').value = '';
                document.getElementById('newAnswer').value = '';
            } else {
                alert(data.message);
            }
        }

        checkAuth();
    </script>
</body>
</html>